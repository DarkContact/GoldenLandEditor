# Age Script (Общее описание)
**Age Script** - упрощённый C-подобный скриптовый язык с ограниченным набором возможностей.  
Скриптовый движок по возможности не генерирует ошибок и не прерывает выполнение, однако в некоторых случаях возможен вылет из игры

## Главные отличия от языка C
- Нельзя объявлять собственные функции. Разрешено использовать только встроенные
- Любой вызов функции должен быть присвоен переменной, иначе он будет проигнорирован движком
- Нет составных операторов присваивания (`+=`, `-=`, `*=`, `/=`, `%=`)
- Нет операторов инкремента и декремента (`a++`, `++a`, `a--`, `--a`)
- Нет управляющих конструкций while, for, switch
- Нет массивов и структур
- Все переменные глобальные (видимы во всех скриптах и диалогах)
- Все переменные игнорируют область видимости


## Типы данных
| Тип      | Описание                 |
|----------|--------------------------|
| `int`    | Целое со знаком          |
| `DWORD`  | Целое без знака          |
| `float`  | Число с плавающей точкой |
| `string` | Строка                   |


## Комментарии
Поддерживаются комментарии в стиле C++:
- Однострочные `// ...`
- Многострочные `/* ... */`


## Объявление переменных
Если нужно объявить переменную со значением можно воспользоваться файлом `scripts/dialog_special/zlato_vars.scr`  
Переменные из этого файла доступны из скриптов уровня и из скриптов диалогов

Особенности:
- Проверка необъявленной переменной на равенство 0 всегда возвращает true
```c
if (a == 0) { /* Проверка прошла успешно, даже если a не объявлена! */ }
```

- Инициализация в объявлении **игнорируется**, переменная всё равно получает значение по умолчанию
```c
int b = 0; // b is "0"
int с = 1; // c is "0"
```

- Значения по умолчанию для разных типов переменных
```c
int i; 	    // i is "0"
DWORD dw;   // dw is "0"
float f;    // f is "0"
string st;  // Невалидное значение, при попытке чтения - вылет из игры
```

Примеры объявлений:
```c
int a; 	     // Значение по умолчанию 0
int b = 0;   // То же самое - значение не присваивается
int d, e, f; // Допускается множественное объявление
```


## Файл zlato_vars.scr
Переменные объявляются одной строкой в следующем формате:  
`<тип> <имя> <значение>`  

Поддерживаются только однострочные комментарии (начинаются с `//`)
```
// Пример фрагмента zlato_vars.scr

int x 5
DWORD LastAnswer 0
float f 0.25
string str "Hello"
```


## Присвоение
```c
int i;
DWORD dw;
float f;
string str;

i = -1;
dw = 1;
f = 0.5;
str = "String";
````
Если выполнить присвоение в **необъявленную** переменную, оно будет проигнорировано без ошибок, и скрипт продолжит выполнение.


## Приведение типов
- Если присвоить значение float переменной int, то дробная часть будет отброшена
- Результат операций с int может быть присвоен float переменной `f = 1 / 2; // Будет 0.5`


## Просмотр и изменение переменных через консоль
Если в игре включена отладочная консоль, можно ввести имя переменной:
- Если переменная не объявлена сообщения не будет
- Если переменная объявлена будет сообщение вида: `x is "0"`
- Если переменная с типом float, значение будет выведено как целое, округлённое по правилам математики (аналог `std::round`)
- **Осторожно!** Если строковая переменная объявлена, но значение ей не присвоено будет вылет из игры

Если через пробел ввести значение, то оно будет присвоенно переменной: `x 5`


## Операторы

### Арифметические
`+`, `-`, `*`, `/`, `%`

### Сравнения
`==`, `!=`, `>`, `<`, `>=`, `<=`

### Логические
`&&` - логическое И  
`||` - логическое ИЛИ  
`^^` - исключающее ИЛИ (XOR)  
`!`  - логическое НЕ

### Побитовые
`&`  - побитовое И  
`|`  - побитовое ИЛИ  
`^`  - побитовый XOR  
`~`  - побитовое НЕ  
`<<` - сдвиг влево  
`>>` - сдвиг вправо


## Оператор goto
Поддерживается в соответствии с C99  
Подробнее: https://en.cppreference.com/w/c/language/goto.html


## Оператор if-else
Условие в `if` обязательно должно быть заключено в круглые скобки  
Фигурные скобки у тела оператора — необязательные
```c
if a == 1 { /* Не сработает */ } 
if (a == 1) { /* Корректно */ } 

if (a >= 5) { }
else { }
```

Конструкция `else if` - не поддерживается
```c
// Не будет работать как ожидается
if (a == 1) {
	test = Console("if (a == 1)");
} else if (a == 2) {
	test = Console("else if (a == 2)");
} else {
	test = Console("else");
}

// Правильный вариант
if (a == 1) {
	test = Console("if (a == 1)");
} else {
	if (a == 2) {
		test = Console("else if (a == 2)");
	}  else {
		test = Console("else");
	}
}
```

Сравнение строк не работает. Условие всегда будет истинно
```c
// Будет вывод текста "Hello"
string st;
st = "World";
if (st == "Hello") { 
	test = Console("Hello");
}
```


## Особенности выполнения диалогов
При наличии в скрипте функций `D_Say` и `D_Answer`, скрипт будет выполнен до конца и будет ожидать ответа от пользователя.  
Во время первого ожидания переменные LastPhrase и LastAnswer устанавливаются в 0.  
После выбора варианта ответа будет установлена переменная LastPhrase и LastAnswer, а скрипт будет перезапущен
```c
int dialog_branch;

//--------------------------------------
// Первый запуск диалога
// LastAnswer и LastPhrase = 0
//--------------------------------------
if (dialog_branch == 0)
{	
	result = D_Say(10);
	result = D_Answer(8);
	result = D_Answer(6);
    dialog_branch = 1;
}

//--------------------------------------
// Ветка диалога при выборе ответа 8
//--------------------------------------
if (dialog_branch == 1 && LastAnswer == 8) {
	result = D_Say(22);
	result = RS_GetRandMinMaxI(0, 10);
	if (result <= 5) {
		result = D_Answer(2181);
	}
	result = D_Answer(6);
	dialog_branch = 2;
}

//--------------------------------------
// Завершение диалога и возврат к началу
//--------------------------------------
if (dialog_branch != 0 && (LastAnswer == 6 || LastAnswer == 2181)) {
	dialog_branch = 0;
}
```


## Встроенные функции
Описание всех функций в файле [AgeScriptFunctions.md](AgeScriptFunctions.md)


## Полезные советы

### Эмуляция цикла while
```c
i = 1;
start:
	result = Console("print");
	i = i + 1;
	if (i <= 5) goto start;
```

### Вывести значение переменной в консоль
```c
var = 255;
result = Cmd("var");
```
