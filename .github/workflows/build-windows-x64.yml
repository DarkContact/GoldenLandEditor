name: Windows Build (MSVC x64)

on:
  push:
    branches: [ master ]
    paths: ['VERSION']
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    outputs:
      version: ${{ steps.set_version.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set version output
        id: set_version
        shell: bash
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Install SDL3
        run: python external/get_SDL3.py msvc

      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Configure CMake
        shell: pwsh
        run: |
          cmake -B build -S . `
          -G "Ninja" `
          -DCMAKE_BUILD_TYPE=Release `
          -DGOLDENLAND_ENABLE_STATIC_RUNTIME=ON `
          -DGOLDENLAND_ENABLE_COPY_DLL=ON `
          -DIMGUI_ENABLE_DEMO=OFF

      - name: Build project
        run: cmake --build build --config Release --parallel

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-build
          path: |
            build/*.exe
            build/*.dll

  release:
    runs-on: ubuntu-latest
    needs: build  # Ждём окончания сборки

    steps:
      - name: Use version from build
        run: |
          echo "Version is ${{ needs.build.outputs.version }}"
          echo "VERSION=${{ needs.build.outputs.version }}" >> $GITHUB_ENV

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-x64-build
          path: release-files  # Скачиваем в эту папку

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          release_name: GoldenLandEditor v${{ env.VERSION }}
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload EXE
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: release-files/GoldenLandEditor.exe
          asset_name: GoldenLandEditor.exe
          asset_content_type: application/octet-stream

      - name: Upload DLLs
        run: |
          for file in release-files/*.dll; do
            echo "Uploading $file"
            gh release upload ${{ env.VERSION }} "$file" --clobber
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
